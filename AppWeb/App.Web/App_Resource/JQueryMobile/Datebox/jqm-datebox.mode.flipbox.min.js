/*! FLIPBOX/TIMEFLIPBOX/DURATIONFLIPBOX Mode */
(function(a){a.extend(a.mobile.datebox.prototype.options,{themeDatePick:"b",themeDate:"a",useSetButton:true,validHours:false,flen:{y:15,m:12,d:20,h:12,i:15,},durationStep:1,durationSteppers:{d:1,h:1,i:1,s:1}});a.extend(a.mobile.datebox.prototype,{_fbox_pos:function(){var e,g,f,c,b=this,d=this.d.intHTML.find(".ui-datebox-flipcontent").innerHeight();b.d.intHTML.find(".ui-datebox-flipcenter").each(function(){g=a(this);f=g.innerHeight();g.css("top",((d/2)-(f/2)-3)*-1)});b.d.intHTML.find("ul").each(function(){g=a(this);d=g.parent().innerHeight();f=g.find("li").first();c=g.find("li").last().offset().top-g.find("li").first().offset().top;e=(((c-d)/2)+f.outerHeight())*-1;f.css("marginTop",e)})},_fbox_fixstep:function(b){var c=this.options.durationSteppers,d=this.options.durationStep;if(a.inArray("h",b)>-1){c.d=1;c.h=d}if(a.inArray("i",b)>-1){c.h=1;c.i=d}if(a.inArray("s",b)>-1){c.i=1;c.s=d}},_fbox_series:function(l,h,j,d){var b,f,c=this.options,k=(j==="h")?24:60,g=[[l.toString(),l]];for(var e=1;e<=h;e++){b=l+(e*c.durationSteppers[j]);f=l-(e*c.durationSteppers[j]);g.unshift([b.toString(),b]);if(f>-1){g.push([f.toString(),f])}else{if(d){g.push([(k+f).toString(),f])}else{g.push(["",-1])}}}return g},_fbox_mktxt:{y:function(b){return this.theDate.get(0)+b},m:function(c){var b=(this.theDate.copy([0],[0,0,1])).adj(1,c);return this.__("monthsOfYearShort")[b.get(1)]},d:function(b){return(this.theDate.copy([0,0,b])).get(2)},h:function(c){var b=this.theDate.copy([0,0,0,c]);return((this.__("timeFormat")===12)?b.get12hr():b.get(3))},i:function(b){return this._zPad((this.theDate.copy([0,0,0,0,b])).get(4))}}});a.extend(a.mobile.datebox.prototype._build,{timeflipbox:function(){this._build.flipbox.apply(this)},durationflipbox:function(){this._build.flipbox.apply(this)},flipbox:function(){var r,l,d,u,h,f,n=this,p=this.options,t=this.drag,x={},c=["d","h","i","s"],q=(p.mode==="durationflipbox"?true:false),k="ui-datebox-",v=a("<div class='ui-overlay-shadow'><ul></ul></div>"),m=a("<div>",{"class":k+"flipcontent"}),j=n.theDate.getTime()-n.initDate.getTime(),s=n._dur(j<0?0:j),e,b;if(j<0){n.lastDuration=0;if(q){n.theDate.setTime(n.initDate.getTime())}}if(typeof n.d.intHTML!=="boolean"){n.d.intHTML.empty().remove()}else{n.d.input.on("datebox",function(i,g){if(g.method==="postrefresh"){n._fbox_pos()}})}n.d.headerText=((n._grabLabel()!==false)?n._grabLabel():((p.mode==="flipbox")?n.__("titleDateDialogLabel"):n.__("titleTimeDialogLabel")));n.d.intHTML=a("<span>");a(document).one("popupafteropen",function(){n._fbox_pos()});n.fldOrder=(p.mode==="flipbox")?n.__("dateFieldOrder"):(q)?n.__("durationOrder"):n.__("timeFieldOrder");if(!q){n._check();n._minStepFix()}if(p.mode==="flipbox"){a("<div class='"+k+"header'><h4>"+n._formatter(n.__("headerFormat"),n.theDate)+"</h4></div>").appendTo(n.d.intHTML)}if(q){n._fbox_fixstep(n.fldOrder);u=a("<div class='"+k+"header ui-grid-"+n._gridblk.g[n.fldOrder.length]+"'></div>");for(l=0;l<n.fldOrder.length;l++){a("<div class='"+k+"fliplab ui-block-"+n._gridblk.b[l]+"'>"+n.__("durationLabel")[a.inArray(n.fldOrder[l],c)]+"</div>").appendTo(u)}u.appendTo(n.d.intHTML);n.dateOK=true;x.d=n._fbox_series(s[0],16,"d",false);x.h=n._fbox_series(s[1],16,"h",(s[0]>0));x.i=n._fbox_series(s[2],20,"i",(s[0]>0||s[1]>0));x.s=n._fbox_series(s[3],20,"s",(s[0]>0||s[1]>0||s[2]>0));m.addClass(k+"flipcontentd");for(l=0;l<n.fldOrder.length;l++){f=n.fldOrder[l];e=s[a.inArray(f,c)];d=n._makeEl(v,{attr:{field:f,amount:p.durationSteppers[f]}});h=d.find("ul");for(r in x[f]){a("<li><span>"+x[f][r][0]+"</span></li>").addClass("ui-body-"+((x[f][r][1]!==e)?p.themeDate:p.themeDatePick)).appendTo(h)}d.appendTo(m)}}for(l=0;(l<n.fldOrder.length&&!q);l++){e=n.fldOrder[l];d=n._makeEl(v,{attr:{field:e,amount:1}});h=d.find("ul");if(typeof n._fbox_mktxt[e]==="function"){for(r=-1*p.flen[e];r<(p.flen[e]+1);r++){a("<li class='ui-body-"+((r!==0)?p.themeDate:p.themeDatePick)+"'><span>"+n._fbox_mktxt[e].apply(n,[r])+"</span></li>").appendTo(h)}d.appendTo(m)}if(e==="a"&&n.__("timeFormat")===12){b=a("<li class='ui-body-"+p.themeDate+"'><span></span></li>");u=(n.theDate.get(3)>11)?[p.themeDate,p.themeDatePick,2,5]:[p.themeDatePick,p.themeDate,2,3];for(r=-1*u[2];r<u[3];r++){if(r<0||r>1){b.clone().appendTo(h)}else{a("<li>",{"class":"ui-body-"+u[r]}).html("<span>"+n.__("meridiem")[r]+"</span>").appendTo(h)}}d.appendTo(m)}}n.d.intHTML.append(m);a("<div>",{"class":k+"flipcenter ui-overlay-shadow"}).css("pointerEvents","none").appendTo(n.d.intHTML);if(p.useSetButton||p.useClearButton){l=a("<div>",{"class":k+"controls"});if(p.useSetButton){l.append(n._stdBtn.close.apply(n,[(p.mode==="flipbox")?n.__("setDateButtonLabel"):(q)?n.__("setDurationButtonLabel"):n.__("setTimeButtonLabel")]))}if(p.useClearButton){l.append(n._stdBtn.clear.apply(n))}if(p.useCollapsedBut){l.controlgroup({type:"horizontal"});l.addClass("ui-datebox-collapse")}else{l.controlgroup()}l.appendTo(n.d.intHTML)}if(n.wheelExists){n.d.intHTML.on("mousewheel",".ui-overlay-shadow",function(g,i){g.preventDefault();n._offset(a(this).data("field"),((i<0)?-1:1)*a(this).data("amount"))})}n.d.intHTML.on(t.eStart,"ul",function(i,g){if(!t.move){if(typeof g!=="undefined"){i=g}t.move=true;t.target=a(this).find("li").first();t.pos=parseInt(t.target.css("marginTop").replace(/px/i,""),10);t.start=n.touch?i.originalEvent.changedTouches[0].pageY:i.pageY;t.end=false;t.direc=(q)?-1:1;i.stopPropagation();i.preventDefault()}})}});a.extend(a.mobile.datebox.prototype._drag,{timeflipbox:function(){this._drag.flipbox.apply(this)},durationflipbox:function(){this._drag.flipbox.apply(this)},flipbox:function(){var b=this,d=this.options,c=this.drag;a(document).on(c.eMove,function(f){if(c.move&&d.mode.slice(-7)==="flipbox"){c.end=b.touch?f.originalEvent.changedTouches[0].pageY:f.pageY;c.target.css("marginTop",(c.pos+c.end-c.start)+"px");f.preventDefault();f.stopPropagation();return false}});a(document).on(c.eEnd,function(f){if(c.move&&d.mode.slice(-7)==="flipbox"){c.move=false;if(c.end!==false){f.preventDefault();f.stopPropagation();c.tmp=c.target.parent().parent();b._offset(c.tmp.data("field"),(parseInt((c.start-c.end)/(c.target.outerHeight()-2),10)*c.tmp.data("amount")*c.direc))}c.start=false;c.end=false}})}})})(jQuery);